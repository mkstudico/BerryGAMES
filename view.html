<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Berry Game Store - Your Ultimate Gaming Destination</title>
    <link rel="icon" type="image/x-icon" href="favicon.ico">
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
    <link rel="manifest" href="/site.webmanifest">
    <style>
        /* [Previous CSS remains exactly the same] */
        
        /* Add these new styles */
        .search-container {
            position: relative;
            width: 100%;
        }
        
        .search-results {
            position: absolute;
            top: 100%;
            left: 0;
            width: 100%;
            background-color: #2a2a2a;
            border-radius: 0 0 20px 20px;
            max-height: 300px;
            overflow-y: auto;
            z-index: 1000;
            display: none;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }
        
        .search-result-item {
            padding: 10px 15px;
            cursor: pointer;
            border-bottom: 1px solid #444;
            display: flex;
            align-items: center;
        }
        
        .search-result-item:hover {
            background-color: #3a3a3a;
        }
        
        .search-result-image {
            width: 40px;
            height: 40px;
            object-fit: cover;
            border-radius: 5px;
            margin-right: 10px;
        }
        
        .wishlist-btn {
            background: none;
            border: none;
            color: #aaa;
            cursor: pointer;
            font-size: 1.2em;
            transition: color 0.3s;
            margin-left: 10px;
        }
        
        .wishlist-btn.active {
            color: #FF5722;
        }
        
        .like-btn {
            background: none;
            border: none;
            color: #aaa;
            cursor: pointer;
            font-size: 1.2em;
            transition: color 0.3s;
            margin-left: 5px;
        }
        
        .like-btn.active {
            color: #4CAF50;
        }
        
        .game-actions {
            display: flex;
            align-items: center;
            margin-top: 10px;
        }
        
        .game-stats {
            display: flex;
            align-items: center;
            font-size: 0.9em;
            color: #aaa;
        }
        
        .game-stats span {
            margin-right: 15px;
            display: flex;
            align-items: center;
        }
        
        .game-stats i {
            margin-right: 5px;
        }
    </style>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
</head>
<body>
    <!-- [Previous HTML remains exactly the same until the search bar] -->
    
    <div class="search-bar">
        <div class="search-container">
            <input type="text" placeholder="Search games by title, genre, or description..." id="search-input" oninput="handleSearchInput()">
            <button type="button" onclick="executeSearch()">üîç</button>
            <div class="search-results" id="search-results"></div>
        </div>
    </div>
    
    <!-- [Rest of previous HTML remains the same] -->
    
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.0/firebase-app.js";
        import { 
            getFirestore, 
            collection, 
            getDocs, 
            doc, 
            getDoc,
            setDoc,
            updateDoc,
            arrayUnion,
            arrayRemove,
            query,
            where
        } from "https://www.gstatic.com/firebasejs/11.6.0/firebase-firestore.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.0/firebase-auth.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDANYS44qmTxUZb40SK50di8XHwaeOiPkM",
            authDomain: "sub-ed-62348.firebaseapp.com",
            projectId: "sub-ed-62348",
            storageBucket: "sub-ed-62348.appspot.com",
            messagingSenderId: "133365566054",
            appId: "1:133365566054:web:966a40fe8443d29aabfba7",
            measurementId: "G-MYR2K02YPK"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        let cart = [];
        let allGames = [];
        let currentUser = null;
        let userEmail = null;
        let currentPlan = "0";
        let userWishlist = [];
        let userLikes = [];
        let searchTimeout = null;

        // Initialize the application
        async function init() {
            await checkAuthState();
            loadCartFromStorage();
            loadGames();
        }

        // Check authentication state
        async function checkAuthState() {
            return new Promise((resolve) => {
                onAuthStateChanged(auth, async (user) => {
                    const authButtons = document.getElementById('auth-buttons');
                    
                    if (user) {
                        currentUser = user;
                        userEmail = user.email;
                        await loadUserData();
                        
                        authButtons.innerHTML = `
                            <button class="login-btn" onclick="window.location.href='plans.html'">Plans</button>
                            <button class="logout-btn" id="logout-btn">Log Out</button>
                        `;
                        document.getElementById('logout-btn').addEventListener('click', handleLogout);
                    } else {
                        currentUser = null;
                        userEmail = null;
                        currentPlan = "0";
                        userWishlist = [];
                        userLikes = [];
                        
                        authButtons.innerHTML = `
                            <button class="login-btn" onclick="window.location.href='sign.html'">Login</button>
                            <button class="signup-btn" id="signup-btn">Sign Up</button>
                        `;
                        document.getElementById('signup-btn').addEventListener('click', () => {
                            window.location.href = 'sign.html';
                        });
                    }
                    resolve();
                });
            });
        }

        // Load user data from Firestore
        async function loadUserData() {
            if (!userEmail) return;
            
            const userDoc = await getDoc(doc(db, "users", userEmail));
            if (userDoc.exists()) {
                currentPlan = userDoc.data().plan || "0";
                userWishlist = userDoc.data().wishlist || [];
                userLikes = userDoc.data().likes || [];
            } else {
                currentPlan = "0";
                userWishlist = [];
                userLikes = [];
                await setDoc(doc(db, "users", userEmail), {
                    plan: "0",
                    wishlist: [],
                    likes: []
                };
            }
        }

        // Handle logout
        async function handleLogout() {
            try {
                await signOut(auth);
                window.location.reload();
            } catch (error) {
                console.error("Logout error:", error);
                alert("Error logging out: " + error.message);
            }
        }

        // Load games from Firestore
        async function loadGames() {
            const querySnapshot = await getDocs(collection(db, "games"));
            allGames = [];
            querySnapshot.forEach((doc) => {
                allGames.push({ id: doc.id, ...doc.data() });
            });
            filterGames('all');
        }

        // Enhanced search functionality
        function handleSearchInput() {
            clearTimeout(searchTimeout);
            const searchTerm = document.getElementById('search-input').value.trim();
            
            if (searchTerm.length < 2) {
                document.getElementById('search-results').style.display = 'none';
                return;
            }
            
            searchTimeout = setTimeout(() => {
                executeSearch(true);
            }, 300);
        }

        function executeSearch(isInstant = false) {
            const searchTerm = document.getElementById('search-input').value.trim().toLowerCase();
            const resultsContainer = document.getElementById('search-results');
            
            if (searchTerm.length < 2) {
                resultsContainer.style.display = 'none';
                return;
            }
            
            // Search in title, description, and genres
            const results = allGames.filter(game => {
                return (
                    game.title.toLowerCase().includes(searchTerm) ||
                    (game.description && game.description.toLowerCase().includes(searchTerm)) ||
                    (game.genres && game.genres.some(genre => genre.toLowerCase().includes(searchTerm)))
                );
            });
            
            displaySearchResults(results);
            
            if (isInstant) {
                resultsContainer.style.display = results.length ? 'block' : 'none';
            } else {
                // For explicit search button click
                filterGames('all');
                const filtered = allGames.filter(game => 
                    game.title.toLowerCase().includes(searchTerm)
                );
                displayGames(filtered, 'search');
            }
        }

        function displaySearchResults(results) {
            const resultsContainer = document.getElementById('search-results');
            resultsContainer.innerHTML = '';
            
            if (results.length === 0) {
                resultsContainer.innerHTML = '<div class="search-result-item">No games found</div>';
                return;
            }
            
            results.slice(0, 5).forEach(game => {
                const resultItem = document.createElement('div');
                resultItem.className = 'search-result-item';
                resultItem.innerHTML = `
                    <img src="${game.image}" alt="${game.title}" class="search-result-image">
                    <div>
                        <div>${game.title}</div>
                        <div style="font-size: 0.8em; color: #aaa;">$${game.price.toFixed(2)}</div>
                    </div>
                `;
                resultItem.addEventListener('click', () => {
                    window.location.href = `view.html?game=${game.id}`;
                });
                resultsContainer.appendChild(resultItem);
            });
        }

        // Filter games based on class and user's plan
        function filterGames(gameClass) {
            const gameGrid = document.getElementById('game-grid');
            gameGrid.innerHTML = '';

            // Update active category
            document.querySelectorAll('.category').forEach(cat => {
                cat.classList.remove('active');
                if (cat.textContent === 'All Games' && gameClass === 'all') cat.classList.add('active');
                if (cat.textContent === 'Free' && gameClass === '0') cat.classList.add('active');
                if (cat.textContent === 'Class A' && gameClass === 'A') cat.classList.add('active');
                if (cat.textContent === 'Class B' && gameClass === 'B') cat.classList.add('active');
                if (cat.textContent === 'Class C' && gameClass === 'C') cat.classList.add('active');
            });

            // Filter games based on category
            const filteredGames = gameClass === 'all' ? allGames : allGames.filter(game => game.class === gameClass);

            // Filter based on user's plan
            const allowedClasses = ["0"];
            if (currentPlan === "A") allowedClasses.push("A");
            else if (currentPlan === "B") allowedClasses.push("A", "B");
            else if (currentPlan === "C") allowedClasses.push("A", "B", "C");

            const displayGames = filteredGames.filter(game => {
                const gameClassValue = game.class || "0";
                return allowedClasses.includes(gameClassValue);
            });

            displayGames(displayGames, gameClass);
        }

        // Display games with wishlist and like functionality
        function displayGames(games, context) {
            const gameGrid = document.getElementById('game-grid');
            
            if (context !== 'search') {
                gameGrid.innerHTML = '';
            }
            
            if (games.length === 0) {
                gameGrid.innerHTML = '<p style="text-align: center; color: #aaa; grid-column: 1 / -1;">No games found</p>';
                return;
            }

            games.forEach(game => {
                const isWishlisted = userWishlist.includes(game.id);
                const isLiked = userLikes.includes(game.id);
                const likeCount = game.likes || 0;
                
                const gameCard = document.createElement('a');
                gameCard.href = `view.html?game=${game.id}`;
                gameCard.className = 'game-card';
                gameCard.setAttribute('data-class', game.class || '0');
                gameCard.innerHTML = `
                    <img src="${game.image}" alt="${game.title}" class="game-image">
                    <div class="game-info">
                        <h3 class="game-title">${game.title}</h3>
                        <div class="rating">${game.rating}</div>
                        <div class="game-stats">
                            <span><i class="fas fa-heart"></i> ${likeCount}</span>
                            <span><i class="fas fa-eye"></i> ${game.views || 0}</span>
                        </div>
                        <div class="game-price">
                            <div>
                                <span class="price">$${game.price.toFixed(2)}</span>
                                ${game.originalPrice ? `<span class="original-price">$${game.originalPrice.toFixed(2)}</span>` : ''}
                                ${game.discount ? `<span class="discount">${game.discount}%</span>` : ''}
                            </div>
                            <div class="game-actions">
                                <button class="add-to-cart" onclick="addToCart('${game.id}', '${game.title}', ${game.price}); event.preventDefault();">+</button>
                                <button class="wishlist-btn ${isWishlisted ? 'active' : ''}" onclick="toggleWishlist('${game.id}'); event.preventDefault();">
                                    <i class="fas fa-bookmark"></i>
                                </button>
                                <button class="like-btn ${isLiked ? 'active' : ''}" onclick="toggleLike('${game.id}'); event.preventDefault();">
                                    <i class="fas fa-thumbs-up"></i>
                                </button>
                            </div>
                        </div>
                        ${game.class && game.class !== '0' ? `<div class="game-class">Class ${game.class}</div>` : ''}
                    </div>
                `;
                gameGrid.appendChild(gameCard);
            });
        }

        // Wishlist functionality
        async function toggleWishlist(gameId) {
            if (!currentUser) {
                alert('Please login to use wishlist');
                window.location.href = 'sign.html';
                return;
            }
            
            try {
                const userRef = doc(db, "users", userEmail);
                
                if (userWishlist.includes(gameId)) {
                    await updateDoc(userRef, {
                        wishlist: arrayRemove(gameId)
                    });
                    userWishlist = userWishlist.filter(id => id !== gameId);
                } else {
                    await updateDoc(userRef, {
                        wishlist: arrayUnion(gameId)
                    });
                    userWishlist.push(gameId);
                }
                
                // Update UI
                const wishlistBtn = document.querySelector(`.wishlist-btn[onclick*="${gameId}"]`);
                if (wishlistBtn) {
                    wishlistBtn.classList.toggle('active');
                }
            } catch (error) {
                console.error("Error updating wishlist:", error);
                alert("Error updating wishlist");
            }
        }

        // Like functionality
        async function toggleLike(gameId) {
            if (!currentUser) {
                alert('Please login to like games');
                window.location.href = 'sign.html';
                return;
            }
            
            try {
                const userRef = doc(db, "users", userEmail);
                const gameRef = doc(db, "games", gameId);
                const gameDoc = await getDoc(gameRef);
                const currentLikes = gameDoc.data().likes || 0;
                
                if (userLikes.includes(gameId)) {
                    // Unlike
                    await updateDoc(userRef, {
                        likes: arrayRemove(gameId)
                    });
                    await updateDoc(gameRef, {
                        likes: currentLikes - 1
                    });
                    userLikes = userLikes.filter(id => id !== gameId);
                } else {
                    // Like
                    await updateDoc(userRef, {
                        likes: arrayUnion(gameId)
                    });
                    await updateDoc(gameRef, {
                        likes: currentLikes + 1
                    });
                    userLikes.push(gameId);
                }
                
                // Update UI
                const likeBtn = document.querySelector(`.like-btn[onclick*="${gameId}"]`);
                if (likeBtn) {
                    likeBtn.classList.toggle('active');
                    
                    // Update like count display
                    const likeCountElement = likeBtn.closest('.game-card').querySelector('.fa-heart').parentElement;
                    const newCount = likeBtn.classList.contains('active') ? currentLikes + 1 : currentLikes;
                    likeCountElement.textContent = ` ${newCount}`;
                }
            } catch (error) {
                console.error("Error updating like:", error);
                alert("Error updating like");
            }
        }

        // Cart functions with localStorage
        function loadCartFromStorage() {
            const savedCart = localStorage.getItem('gameStoreCart');
            if (savedCart) {
                cart = JSON.parse(savedCart);
                updateCartCount();
            }
        }

        function saveCartToStorage() {
            localStorage.setItem('gameStoreCart', JSON.stringify(cart));
        }

        function addToCart(gameId, gameName, price) {
            // Check if already in cart
            if (cart.some(item => item.id === gameId)) {
                alert(`${gameName} is already in your cart`);
                return;
            }
            
            cart.push({ id: gameId, name: gameName, price: price });
            updateCartCount();
            updateCartModal();
            saveCartToStorage();
            alert(`${gameName} added to cart!`);
        }

        function updateCartCount() {
            document.querySelector('.cart-count').textContent = cart.length;
        }

        function updateCartModal() {
            const cartItems = document.getElementById('cart-items');
            const cartSubtotal = document.getElementById('cart-subtotal');

            if (cart.length === 0) {
                cartItems.innerHTML = '<p style="text-align: center; color: #aaa;">Your cart is empty</p>';
                cartSubtotal.textContent = '$0.00';
                return;
            }

            let itemsHTML = '';
            let subtotal = 0;

            cart.forEach(item => {
                subtotal += item.price;
                itemsHTML += `
                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 10px 0; border-bottom: 1px solid #444;">
                        <div>
                            <div style="font-weight: bold;">${item.name}</div>
                            <div style="color: #4CAF50; font-size: 0.9em;">$${item.price.toFixed(2)}</div>
                        </div>
                        <button onclick="removeFromCart('${item.id}')" style="background: none; border: none; color: #FF5722; cursor: pointer;">Remove</button>
                    </div>
                `;
            });

            cartItems.innerHTML = itemsHTML;
            cartSubtotal.textContent = `$${subtotal.toFixed(2)}`;
        }

        function removeFromCart(gameId) {
            cart = cart.filter(item => item.id !== gameId);
            updateCartCount();
            updateCartModal();
            saveCartToStorage();
        }

        // Modal functions
        function openModal(modalId) {
            document.getElementById(modalId).style.display = 'block';
        }

        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
        }

        // Close modal when clicking outside
        window.onclick = function(event) {
            if (event.target.className === 'modal') {
                event.target.style.display = 'none';
            }
            
            // Close search results when clicking elsewhere
            if (!event.target.closest('.search-container')) {
                document.getElementById('search-results').style.display = 'none';
            }
        }

        // Initialize the app
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
